"""
{{ provider.display_name }} AnyCost Adaptor - Data Transformation

Transforms {{ provider.display_name }} data into CloudZero Common Billing Format (CBF).
{% if tier.value == "tier1_credit" %}
Tier 1 (Credit Polling): converts credit delta snapshots to CBF records.
{% elif tier.value == "tier2_structured" %}
Tier 2 (Structured Billing): maps structured billing line items to CBF records.
{% elif tier.value == "tier3_enterprise" %}
Tier 3 (Enterprise): processes complex usage data into CBF records.
{% endif %}

Generated from AnyCost Adaptor Template ({{ tier.value }})
"""

import csv
import hashlib
from datetime import datetime
from pathlib import Path


class {{ provider_class_name }}Transform:
    """Transform {{ provider.display_name }} data to CloudZero CBF format."""

    # CBF column headers
    CBF_HEADERS = [
        "time/usage_start",
        "cost/cost",
        "bill/invoice_id",
        "lineitem/id",
        "lineitem/type",
        "lineitem/description",
        "lineitem/cloud_provider",
        "resource/id",
        "resource/service",
        "resource/account",
        "resource/region",
        "resource/usage_family",
        "usage/amount",
        "usage/units",
        "cost/discounted_cost",
        "cost/amortized_cost",
        "cost/on_demand_cost",
    ]

{% if tier.value == "tier1_credit" %}
{% include 'fragments/transform_simple.py.j2' %}
{% elif tier.value == "tier2_structured" %}
{% include 'fragments/transform_field_mapping.py.j2' %}
{% elif tier.value == "tier3_enterprise" %}
{% include 'fragments/transform_aggregation.py.j2' %}
{% endif %}

{% include 'fragments/cbf_record_builder.py.j2' %}

    def write_cbf(self, records: list[dict], output_path: str):
        """Write CBF records to a CSV file."""
        output = Path(output_path)
        output.parent.mkdir(parents=True, exist_ok=True)

        with open(output, "w", newline="") as f:
            writer = csv.DictWriter(f, fieldnames=self.CBF_HEADERS)
            writer.writeheader()
            writer.writerows(records)

        print(f"Wrote {len(records)} CBF records to {output}")
        return str(output)
